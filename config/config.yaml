# =========================
# ğŸ”§ PORTS & CORE SETTINGS
# =========================
# Mihomo (Clash Meta) Configuration
# Gateway Mode with Multiple Methods Support

port: 7890 # HTTP proxy port
socks-port: 7891 # SOCKS5 proxy port
mixed-port: 7890 # Mixed port (HTTP + SOCKS5)
redir-port: 9797 # Redirect port (for REDIRECT method)
tproxy-port: 9898 # TProxy port (for TPROXY method)

mode: rule
allow-lan: true
bind-address: "*"

# Log level: silent / error / warning / info / debug
log-level: warning # Warning level untuk pantau error ringan

# External Controller (API)
external-controller: 0.0.0.0:9090
external-ui: /var/www/html/mihomo-ui/dashboard
secret: "mihomo-gateway-2024" # Ganti ini!

# IPv6 support (disabled untuk stabilitas)
ipv6: false

# Performance settings
unified-delay: true
tcp-concurrent: true

# Interface name (auto-detect by default)
# interface-name: eth0

# Routing mark
routing-mark: 666

# =========================
# ğŸ”– PROFILE
# =========================
profile:
  store-selected: true
  store-fake-ip: true

# Geodata settings
geodata-mode: true
geox-url:
  geoip: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat"
  geosite: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat"
  mmdb: "https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/country.mmdb"

# =========================
# ğŸŒ DNS SETTINGS
# =========================
dns:
  enable: true
  prefer-h3: false
  listen: 0.0.0.0:1053
  ipv6: false # Disabled untuk stabilitas
  use-hosts: true
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16

  # Default nameserver (bootstrap DNS)
  default-nameserver:
    - 223.5.5.5 # DNS lokal cepat (Alibaba)
    - 1.1.1.1
    - 8.8.8.8

  # Main nameserver
  nameserver:
    - 223.5.5.5
    - 1.1.1.1
    - 8.8.8.8

  # Fallback nameserver
  fallback:
    - 9.9.9.9
    - 1.0.0.1
    - 8.8.4.4

  # Fake-IP filter (PENTING!)
  fake-ip-filter:
    # Sistem lokal (WAJIB)
    - "+.lan"
    - "+.local"
    - "+.localhost"
    - "+.localdomain"
    - "192.168.1.1" # Gateway IP
    - "mihomo-gateway.local"

    # NTP / sinkronisasi waktu (WAJIB)
    - "+.ntp.org"
    - "+.pool.ntp.org"
    - "+.time.windows.com"
    - "+.time.apple.com"
    - "+.time.google.com"

    # Google push notif (WAJIB)
    - "mtalk.google.com"
    - "mtalk4.google.com"

    # STUN untuk VoIP/game (WAJIB)
    - "+.stun.*"
    - "+.stun.playstation.net"

    # GitHub (WAJIB)
    - "+.github.com"
    - "+.githubusercontent.com"
    - "+.ghcr.io"

    # GitLab (WAJIB)
    - "+.gitlab.com"

    # Docker registry (WAJIB)
    - "+.docker.com"
    - "+.docker.io"
    - "+.docker.internal"
    - "+.registry-1.docker.io"

    # CDN provider penting (WAJIB real DNS)
    - "+.cloudflare.com"
    - "+.cloudflare-dns.com"
    - "+.akamaihd.net"
    - "+.cloudfront.net"
    - "+.fastly.net"

    # Streaming (WAJIB)
    - "+.googlevideo.com"
    - "+.nflxvideo.net"
    - "+.netflix.com"

    # Gaming platforms
    - "*.battlenet.com.cn"
    - "*.battlenet.com"
    - "*.blzstatic.cn"
    - "*.battle.net"
    - "+.srv.nintendo.net"
    - "+.xboxlive.com"
    - "xbox.*.microsoft.com"

    # Services
    - "+.msftconnecttest.com"
    - "+.msftncsi.com"
    - "msftconnecttest.com"
    - "+.casaos.local"
    - "localhost.ptlogin2.qq.com"

    # Fix bug Google Lens
    - "lens.l.google.com"

  # Fallback filter
  fallback-filter:
    geoip: true
    geoip-code: ID
    ipcidr:
      - 0.0.0.0/8
      - 10.0.0.0/8
      - 127.0.0.0/8
      - 169.254.0.0/16
      - 172.16.0.0/12
      - 192.168.0.0/16
      - 224.0.0.0/4
      - 240.0.0.0/4
      - 255.255.255.255/32
    domain:
      - "+.google.com"
      - "+.facebook.com"
      - "+.youtube.com"
      - "+.githubusercontent.com"
      - "+.googlevideo.com"

# =========================
# ğŸ§© TUN MODE
# =========================
tun:
  enable: false # Disabled by default (gunakan iptables REDIRECT)
  device: utun
  mtu: 1500 # Turunkan ke 1500 biar stabil di ISP Indonesia
  stack: system
  strict-route: false
  dns-hijack:
    - any:53
    - tcp://any:53
  auto-route: true
  auto-detect-interface: true

# === Proxy Providers ===
# Menggunakan standard naming: proxy-providers
proxy-providers:
  # Provider 1 - Subscription URL
  subscription_provider:
    type: http
    url: "https://example.com/your-subscription-url"
    interval: 3600
    path: /etc/mihomo/proxy_providers/subscription.yaml
    health-check:
      enable: true
      interval: 300
      lazy: false
      url: http://www.gstatic.com/generate_204

  # Provider 2 - Custom proxies (manual)
  custom_provider:
    type: file
    path: /etc/mihomo/proxy_providers/custom.yaml
    health-check:
      enable: true
      interval: 300
      lazy: false
      url: http://www.gstatic.com/generate_204

  # Provider 3 - Backup/fallback provider
  backup_provider:
    type: file
    path: /etc/mihomo/proxy_providers/backup.yaml
    health-check:
      enable: true
      interval: 300
      lazy: false
      url: http://www.gstatic.com/generate_204

# === Rule Providers ===
# Menggunakan standard naming: rule-providers
rule-providers:
  # Reject/Block rules (ads, trackers, malware)
  reject_provider:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt"
    path: /etc/mihomo/rule_providers/reject.yaml
    interval: 86400

  # Proxy rules (sites that need proxy)
  proxy_provider:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt"
    path: /etc/mihomo/rule_providers/proxy.yaml
    interval: 86400

  # Direct rules (local sites, no proxy needed)
  direct_provider:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt"
    path: /etc/mihomo/rule_providers/direct.yaml
    interval: 86400

  # GFW list (blocked sites in China)
  gfw_provider:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt"
    path: /etc/mihomo/rule_providers/gfw.yaml
    interval: 86400

  # Streaming services rules
  streaming_provider:
    type: file
    behavior: domain
    path: /etc/mihomo/rule_providers/streaming.yaml

  # Gaming services rules
  gaming_provider:
    type: file
    behavior: domain
    path: /etc/mihomo/rule_providers/gaming.yaml

  # Social media rules
  social_provider:
    type: file
    behavior: domain
    path: /etc/mihomo/rule_providers/social.yaml

  # Custom rules (your own)
  custom_provider:
    type: file
    behavior: domain
    path: /etc/mihomo/rule_providers/custom.yaml

# === Proxy Groups ===
proxy-groups:
  # Main proxy selector
  - name: "ğŸš€ Proxy"
    type: select
    proxies:
      - "â™»ï¸ Auto"
      - "ğŸ”° Fallback"
      - "âš–ï¸ LoadBalance"
      - "ğŸ¯ Direct"
    use:
      - subscription_provider
      - custom_provider
      - backup_provider

  # Auto select (fastest by latency)
  - name: "â™»ï¸ Auto"
    type: url-test
    use:
      - subscription_provider
      - custom_provider
      - backup_provider
    url: "http://www.gstatic.com/generate_204"
    interval: 300
    tolerance: 50
    lazy: false

  # Fallback (auto switch on failure)
  - name: "ğŸ”° Fallback"
    type: fallback
    use:
      - subscription_provider
      - custom_provider
      - backup_provider
    url: "http://www.gstatic.com/generate_204"
    interval: 300
    lazy: false

  # Load Balance (distribute traffic)
  - name: "âš–ï¸ LoadBalance"
    type: load-balance
    strategy: consistent-hashing
    use:
      - subscription_provider
      - custom_provider
      - backup_provider
    url: "http://www.gstatic.com/generate_204"
    interval: 300
    lazy: false

  # Streaming services (Netflix, YouTube, etc.)
  - name: "ğŸ¬ Streaming"
    type: select
    proxies:
      - "ğŸš€ Proxy"
      - "â™»ï¸ Auto"
      - "ğŸ”° Fallback"
      - "ğŸ¯ Direct"
    use:
      - subscription_provider
      - custom_provider

  # Social Media (Facebook, Instagram, Twitter, etc.)
  - name: "ğŸ“± Social"
    type: select
    proxies:
      - "ğŸš€ Proxy"
      - "â™»ï¸ Auto"
      - "ğŸ”° Fallback"
      - "ğŸ¯ Direct"
    use:
      - subscription_provider
      - custom_provider

  # Gaming (Steam, Epic, etc.)
  - name: "ğŸ® Gaming"
    type: select
    proxies:
      - "ğŸ¯ Direct"
      - "ğŸš€ Proxy"
      - "â™»ï¸ Auto"
    use:
      - subscription_provider
      - custom_provider

  # Direct connection (no proxy)
  - name: "ğŸ¯ Direct"
    type: select
    proxies:
      - DIRECT

  # Reject/Block (ads, trackers)
  - name: "ğŸ›‘ Reject"
    type: select
    proxies:
      - REJECT
      - DIRECT

  # Final rule (when no rule matches)
  - name: "ğŸŸ Final"
    type: select
    proxies:
      - "ğŸš€ Proxy"
      - "â™»ï¸ Auto"
      - "ğŸ”° Fallback"
      - "ğŸ¯ Direct"
    use:
      - subscription_provider
      - custom_provider
      - backup_provider

# =========================
# âš™ï¸ RULES
# =========================
# Semua rules sudah dipindah ke rule-providers
# Edit rules di folder: /etc/mihomo/rule_providers/

rules:
  # Proteksi fake-ip (WAJIB)
  - IP-CIDR,198.18.0.1/16,REJECT,no-resolve

  # Blokir DoH bypass (opsional, uncomment jika perlu)
  # - DOMAIN-SUFFIX,dns.google,REJECT
  # - DOMAIN-SUFFIX,cloudflare-dns.com,REJECT

  # LAN & Private network (always direct)
  - IP-CIDR,192.168.1.0/24,ğŸ¯ Direct,no-resolve # Hotspot network
  - IP-CIDR,10.0.0.0/8,ğŸ¯ Direct,no-resolve # Private network
  - IP-CIDR,172.16.0.0/12,ğŸ¯ Direct,no-resolve # Private + Docker
  - IP-CIDR,192.168.0.0/16,ğŸ¯ Direct,no-resolve # Private network
  - IP-CIDR,127.0.0.0/8,ğŸ¯ Direct,no-resolve # Localhost
  - IP-CIDR,224.0.0.0/4,ğŸ¯ Direct,no-resolve # Multicast
  - IP-CIDR,240.0.0.0/4,ğŸ¯ Direct,no-resolve # Reserved

  # Mihomo Web UI (direct)
  - DST-PORT,9090,ğŸ¯ Direct # Mihomo API

  # Google Push Notification (bypass untuk notif lancar)
  - DOMAIN-SUFFIX,mtalk.google.com,ğŸ¯ Direct
  - DOMAIN-SUFFIX,mtalk4.google.com,ğŸ¯ Direct
  - DST-PORT,5228,ğŸ¯ Direct

  # === Rule Providers (Edit rules di folder rule_providers) ===

  # Custom rules (prioritas tertinggi)
  - RULE-SET,custom_provider,ğŸš€ Proxy

  # Block ads & trackers
  - RULE-SET,reject_provider,ğŸ›‘ Reject

  # Streaming services
  - RULE-SET,streaming_provider,ğŸ¬ Streaming

  # Social media
  - RULE-SET,social_provider,ğŸ“± Social

  # Gaming platforms
  - RULE-SET,gaming_provider,ğŸ® Gaming

  # Sites that need proxy
  - RULE-SET,proxy_provider,ğŸš€ Proxy
  - RULE-SET,gfw_provider,ğŸš€ Proxy

  # Direct connections (Indonesia)
  - GEOIP,ID,ğŸ¯ Direct
  - RULE-SET,direct_provider,ğŸ¯ Direct

  # Final rule (default)
  - MATCH,ğŸŸ Final
